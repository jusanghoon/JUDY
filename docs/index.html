<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나만의 컬렉션 만들기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        // Firebase 앱 초기화 및 서비스 가져오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, deleteDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 구성 정보 (Canvas 환경에서 제공)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" }; // 실제 값으로 대체 필요 (로컬 테스트 시)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Canvas 환경에서 제공

        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // Firestore 로깅 활성화 (디버깅 시 유용)

        let userId = null; // 현재 사용자 ID

        const itemForm = document.getElementById('itemForm');
        const itemTitleInput = document.getElementById('itemTitle');
        const itemNotesInput = document.getElementById('itemNotes');
        const itemImageKeywordInput = document.getElementById('itemImageKeyword');
        const itemImageUrlInput = document.getElementById('itemImageUrl');
        const collectionContainer = document.getElementById('collectionContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const authStateMessage = document.getElementById('authStateMessage');
        const currentUserIdDisplay = document.getElementById('currentUserId');


        // 인증 상태 변경 리스너
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                authStateMessage.textContent = '인증 성공! 컬렉션을 불러옵니다...';
                authStateMessage.className = 'text-green-600 text-sm';
                currentUserIdDisplay.textContent = `사용자 ID: ${userId}`;
                loadCollectionItems();
            } else {
                userId = null;
                authStateMessage.textContent = '인증 정보가 없습니다. 익명으로 로그인 시도 중...';
                authStateMessage.className = 'text-yellow-600 text-sm';
                currentUserIdDisplay.textContent = '사용자 ID: 없음';
                // __initial_auth_token이 있으면 사용, 없으면 익명 로그인
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        // onAuthStateChanged가 다시 호출되어 user 객체와 함께 로직 실행
                    } catch (error) {
                        console.error("커스텀 토큰 로그인 실패:", error);
                        authStateMessage.textContent = '커스텀 토큰 로그인 실패. 익명으로 로그인합니다.';
                        await signInAnonymouslyIfNeeded();
                    }
                } else {
                    await signInAnonymouslyIfNeeded();
                }
            }
        });
        
        async function signInAnonymouslyIfNeeded() {
            if (!auth.currentUser) {
                try {
                    await signInAnonymously(auth);
                    // onAuthStateChanged가 다시 호출되어 user 객체와 함께 로직 실행
                } catch (error) {
                    console.error("익명 로그인 실패:", error);
                    authStateMessage.textContent = '익명 로그인에 실패했습니다. 새로고침 해주세요.';
                    authStateMessage.className = 'text-red-600 text-sm';
                }
            }
        }


        // 컬렉션 아이템 추가
        itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                showUserMessage('사용자 인증이 필요합니다. 잠시 후 다시 시도해주세요.', true);
                return;
            }

            const title = itemTitleInput.value.trim();
            const notes = itemNotesInput.value.trim();
            const imageKeyword = itemImageKeywordInput.value.trim();
            const imageUrl = itemImageUrlInput.value.trim();

            if (!title) {
                showUserMessage('제목을 입력해주세요.', true);
                return;
            }

            try {
                const itemsCollectionPath = `artifacts/${appId}/users/${userId}/my_collections`;
                await addDoc(collection(db, itemsCollectionPath), {
                    title: title,
                    notes: notes,
                    imageKeyword: imageKeyword,
                    imageUrl: imageUrl,
                    createdAt: serverTimestamp() // Firestore 서버 시간으로 기록
                });
                itemForm.reset(); // 폼 초기화
                showUserMessage('컬렉션에 아이템이 추가되었습니다!', false);
            } catch (error) {
                console.error("아이템 추가 오류: ", error);
                showUserMessage('아이템 추가 중 오류가 발생했습니다.', true);
            }
        });

        // 컬렉션 아이템 불러오기 (실시간)
        function loadCollectionItems() {
            if (!userId) return;
            loadingIndicator.classList.remove('hidden');
            
            const itemsCollectionPath = `artifacts/${appId}/users/${userId}/my_collections`;
            // createdAt 필드를 기준으로 내림차순 정렬 (최신 항목이 위로)
            // Firestore는 기본적으로 복합 색인을 요구할 수 있으므로, orderBy를 사용할 때는 콘솔에서 색인 생성 링크를 확인해야 할 수 있습니다.
            // 여기서는 createdAt만 사용하므로 단일 필드 색인은 자동 생성될 가능성이 높습니다.
            const q = query(collection(db, itemsCollectionPath), orderBy("createdAt", "desc"));

            onSnapshot(q, (querySnapshot) => {
                collectionContainer.innerHTML = ''; // 기존 아이템 지우기
                if (querySnapshot.empty) {
                    collectionContainer.innerHTML = '<p class="text-gray-500 text-center col-span-full">아직 컬렉션에 아이템이 없습니다. 첫 아이템을 추가해보세요!</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        renderCollectionItem(doc);
                    });
                }
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("컬렉션 불러오기 오류: ", error);
                showUserMessage('컬렉션을 불러오는 중 오류가 발생했습니다.', true);
                loadingIndicator.classList.add('hidden');
            });
        }

        // 컬렉션 아이템 화면에 그리기
        function renderCollectionItem(docSnapshot) {
            const item = docSnapshot.data();
            const itemId = docSnapshot.id;

            const itemDiv = document.createElement('div');
            itemDiv.className = 'bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 flex flex-col justify-between';

            let imageHtml = '';
            if (item.imageUrl) {
                imageHtml = `
                    <div class="w-full h-48 bg-gray-200 rounded-md mb-4 overflow-hidden flex items-center justify-center">
                        <img src="${item.imageUrl}" alt="${item.title}" class="max-w-full max-h-full object-contain" onerror="this.parentElement.innerHTML = '<span class=\\'text-xs text-gray-500 p-2 text-center\\'>이미지를 불러올 수 없거나<br>URL이 유효하지 않습니다.</span>';">
                    </div>
                `;
            } else if (item.imageKeyword) {
                 imageHtml = `
                    <div class="w-full h-48 bg-gray-100 rounded-md mb-4 flex flex-col items-center justify-center text-center p-2">
                        <p class="text-sm text-gray-600 mb-2">이미지 키워드: "${item.imageKeyword}"</p>
                        <button class="search-image-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-3 rounded-md" data-keyword="${item.imageKeyword}">Google 이미지 검색</button>
                    </div>
                `;
            } else {
                 imageHtml = `
                    <div class="w-full h-48 bg-gray-50 rounded-md mb-4 flex items-center justify-center text-center p-2">
                        <p class="text-sm text-gray-400">(이미지 정보 없음)</p>
                    </div>
                `;
            }


            itemDiv.innerHTML = `
                ${imageHtml}
                <div>
                    <h3 class="text-xl font-semibold text-indigo-700 mb-2 truncate" title="${item.title}">${item.title}</h3>
                    <p class="text-gray-600 text-sm mb-3 whitespace-pre-wrap break-words min-h-[40px]">${item.notes || '메모 없음'}</p>
                    ${item.imageKeyword && !item.imageUrl ? `<p class="text-xs text-gray-500 mb-1">키워드: ${item.imageKeyword}</p>` : ''}
                    <p class="text-xs text-gray-400 mt-2">추가된 날짜: ${item.createdAt ? new Date(item.createdAt.seconds * 1000).toLocaleDateString() : '알 수 없음'}</p>
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    <button class="edit-btn bg-yellow-400 hover:bg-yellow-500 text-white text-xs py-1 px-3 rounded-md" data-id="${itemId}">수정</button>
                    <button class="delete-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-3 rounded-md" data-id="${itemId}">삭제</button>
                </div>
            `;
            
            collectionContainer.appendChild(itemDiv);

            // 이미지 검색 버튼 이벤트 리스너 (아이템이 추가될 때마다 설정)
            itemDiv.querySelectorAll('.search-image-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const keyword = e.target.dataset.keyword;
                    if (keyword) {
                        window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(keyword)}`, '_blank');
                    }
                });
            });

            // 삭제 버튼 이벤트 리스너
            itemDiv.querySelector('.delete-btn').addEventListener('click', async (e) => {
                const docId = e.target.dataset.id;
                // 여기서는 간단한 커스텀 확인창 대신 window.confirm을 사용합니다. (실제 앱에서는 커스텀 UI 권장)
                // Canvas 환경에서는 window.confirm이 제대로 동작하지 않을 수 있으므로, 실제 사용 시 커스텀 모달로 대체해야 합니다.
                // 여기서는 일단 삭제 로직만 구현합니다.
                if (confirm(`'${item.title}' 아이템을 정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
                     try {
                        const itemDocRef = doc(db, `artifacts/${appId}/users/${userId}/my_collections`, docId);
                        await deleteDoc(itemDocRef);
                        showUserMessage('아이템이 삭제되었습니다.', false);
                    } catch (error) {
                        console.error("아이템 삭제 오류: ", error);
                        showUserMessage('아이템 삭제 중 오류가 발생했습니다.', true);
                    }
                }
            });
            
            // 수정 버튼 이벤트 리스너 (간단한 프롬프트 사용, 실제 앱에서는 모달 권장)
            itemDiv.querySelector('.edit-btn').addEventListener('click', async (e) => {
                const docId = e.target.dataset.id;
                const currentItem = docSnapshot.data(); // 현재 데이터 가져오기

                const newTitle = prompt("새 제목을 입력하세요:", currentItem.title);
                if (newTitle === null) return; // 사용자가 취소한 경우

                const newNotes = prompt("새 메모를 입력하세요:", currentItem.notes);
                 if (newNotes === null) return;

                const newImageKeyword = prompt("새 이미지 키워드를 입력하세요:", currentItem.imageKeyword);
                 if (newImageKeyword === null) return;
                
                const newImageUrl = prompt("새 직접 이미지 URL을 입력하세요:", currentItem.imageUrl);
                 if (newImageUrl === null) return;


                try {
                    const itemDocRef = doc(db, `artifacts/${appId}/users/${userId}/my_collections`, docId);
                    await updateDoc(itemDocRef, {
                        title: newTitle.trim(),
                        notes: newNotes.trim(),
                        imageKeyword: newImageKeyword.trim(),
                        imageUrl: newImageUrl.trim(),
                        // createdAt은 수정하지 않음
                    });
                    showUserMessage('아이템이 수정되었습니다.', false);
                } catch (error) {
                    console.error("아이템 수정 오류: ", error);
                    showUserMessage('아이템 수정 중 오류가 발생했습니다.', true);
                }
            });
        }
        
        // 사용자 메시지 표시 함수
        const userMessageElement = document.getElementById('userMessage');
        function showUserMessage(message, isError = false) {
            userMessageElement.textContent = message;
            userMessageElement.className = `text-sm mt-4 text-center ${isError ? 'text-red-500' : 'text-green-500'}`;
            setTimeout(() => {
                userMessageElement.textContent = '';
            }, 3000); // 3초 후 메시지 사라짐
        }

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Firefox 스크롤바 스타일 (선택 사항) */
        .whitespace-pre-wrap { white-space: pre-wrap; word-break: break-word; }
        /* 로딩 스피너 */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    <div class="container mx-auto max-w-4xl">
        <header class="mb-10 text-center">
            <h1 class="text-4xl sm:text-5xl font-bold text-indigo-600">✨ 나만의 컬렉션 만들기</h1>
            <p class="text-gray-600 mt-3 text-lg">소중한 아이디어와 정보를 기록하고 관리하세요.</p>
            <p id="currentUserId" class="text-xs text-gray-500 mt-1"></p>
        </header>

        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl mb-10">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">새 아이템 추가하기</h2>
            <form id="itemForm" class="space-y-6">
                <div>
                    <label for="itemTitle" class="block text-sm font-medium text-gray-700 mb-1">제목 <span class="text-red-500">*</span></label>
                    <input type="text" id="itemTitle" name="itemTitle" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                           placeholder="예: 멋진 여행지 아이디어">
                </div>
                <div>
                    <label for="itemNotes" class="block text-sm font-medium text-gray-700 mb-1">메모 / 설명</label>
                    <textarea id="itemNotes" name="itemNotes" rows="4"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                              placeholder="아이템에 대한 자세한 내용을 적어보세요..."></textarea>
                </div>
                <div>
                    <label for="itemImageKeyword" class="block text-sm font-medium text-gray-700 mb-1">이미지 키워드 (Google 검색용)</label>
                    <input type="text" id="itemImageKeyword" name="itemImageKeyword"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                           placeholder="예: 파란 하늘과 바다">
                </div>
                <div>
                    <label for="itemImageUrl" class="block text-sm font-medium text-gray-700 mb-1">직접 이미지 URL (선택 사항)</label>
                    <input type="url" id="itemImageUrl" name="itemImageUrl"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                           placeholder="https://example.com/image.jpg (표시되지 않을 수 있음)">
                </div>
                <button type="submit"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out transform hover:-translate-y-0.5">
                    컬렉션에 추가하기
                </button>
            </form>
            <div id="userMessage" class="text-sm mt-4 text-center"></div>
            <div id="authStateMessage" class="text-sm mt-2 text-center text-gray-500">인증 상태 확인 중...</div>
        </div>

        <section>
            <h2 class="text-3xl font-semibold text-gray-800 mb-8 text-center">나의 컬렉션</h2>
            <div id="loadingIndicator" class="loader hidden"></div>
            <div id="collectionContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- 컬렉션 아이템들이 여기에 표시됩니다. -->
            </div>
        </section>

        <footer class="mt-16 text-center text-sm text-gray-500 py-8 border-t border-gray-200">
            <p>&copy; <span id="appYear">2024</span> 나만의 컬렉션 만들기. 모든 권리 보유.</p>
            <script>document.getElementById('appYear').textContent = new Date().getFullYear();</script>
        </footer>
    </div>
</body>
</html>
